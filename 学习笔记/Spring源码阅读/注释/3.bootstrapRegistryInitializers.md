### `BootstrapRegistryInitializer`

> `BootstrapRegistryInitializer`是一个函数式接口
>
> ```java
> @FunctionalInterface
> public interface BootstrapRegistryInitializer {
> 
> 	/**
> 	 * Initialize the given {@link BootstrapRegistry} with any required registrations.
> 	 * @param registry the registry to initialize
> 	 */
> 	void initialize(BootstrapRegistry registry);
> }
> ```
>

#### 1.`BootstrapRegistry`接口

1. `BootstrapRegistry`中定义了五个方法，一个内部类，一个内部枚举

   - ```java
     /**
      * Register a specific type with the registry. If the specified type has already been
      * registered and has not been obtained as a {@link Scope#SINGLETON singleton}, it
      * will be replaced.
      * @param <T> the instance type
      * @param type the instance type
      * @param instanceSupplier the instance supplier
      */
     <T> void register(Class<T> type, InstanceSupplier<T> instanceSupplier);
     ```

     

   - ==暂不写==

#### 2.`InstanceSupplier`函数式接口

`InstanceSupplier`是`BootstrapRegistry`的一个内部类

```java
/**
 * Factory method used to create the instance when needed.
 * @param context the {@link BootstrapContext} which may be used to obtain other
 * bootstrap instances.
 * @return the instance
 */
T get(BootstrapContext context);
```

#### 3.根据测试工程`spring-boot-smoke-test-bootstrap-registry`

```java
public static void main(String[] args) {
   // This example shows how a Bootstrapper can be used to register a custom
   // SubversionClient that still has access to data provided in the
   // application.properties file
   SpringApplication application = new SpringApplication(SampleBootstrapRegistryApplication.class);
    //在此处的入参为 BootstrapRegistryInitializer
    //构造 BootstrapRegistryInitializer 的入参为 MySubversionClient 的构造函数 
    //MySubversionClient继承了SubversionClient 实际执行的是下面方法 ↓
	//public SubversionClient(SubversionServerCertificate serverCertificate) {
	//	this.serverCertificate = serverCertificate;
	//}
    // 涉及到 withCustomClient 方法 ↓↓
   application.addBootstrapRegistryInitializer(SubversionBootstrap.withCustomClient(MySubversionClient::new));
   application.run(args);
}

/**
 * Return a {@link BootstrapRegistryInitializer} for the given client factory.
 *
 * @param clientFactory the client factory
 * 是一个入参为：SubversionServerCertificate 出参为：SubversionClient 的函数
 * 
 * @return a {@link BootstrapRegistryInitializer} instance
 * 返回值是 BootstrapRegistryInitializer 的实例（详见标题[BootstrapRegistryInitializer]）
 * 就需要定义BootstrapRegistryInitializer函数，其入参为 BootstrapRegistry
 */
public static BootstrapRegistryInitializer withCustomClient(
        Function<SubversionServerCertificate, SubversionClient> clientFactory) {
    //此处使用了BootstrapRegistry 中的 register方法（详见标题[2]）
    //就需要继续定义InstanceSupplier函数
    return (registry) -> registry.register(SubversionClient.class,
            (bootstrapContext) -> createSubversionClient(bootstrapContext, clientFactory));
}

private static SubversionClient createSubversionClient(BootstrapContext bootstrapContext,
        Function<SubversionServerCertificate, SubversionClient> clientFactory) {
    return clientFactory.apply(bootstrapContext.get(SubversionServerCertificate.class));
}
```

> **run方法中的`DefaultBootstrapContext bootstrapContext = createBootstrapContext();`**将会执行以下步骤
>
> 1. 注册`SubversionClient`需要提供`SubversionClient.class` 和实例化他的方法（构造函数）
> 2. `SubversionClient`实例化-->实例化需要用到`SubversionServerCertificate`
> 3. `SubversionServerCertificate`从`BootstrapContext`中取
> 4. 将`SubversionClient.class`和实例化方法放到`DefaultBootstrapContext.instanceSuppliers`（`Map<Class<?>, InstanceSupplier<?>>`）中

